---
import AppLayout from "../layouts/AppLayout.astro";
import { OnboardingContainer } from "../components/onboarding/OnboardingContainer";

// Don't check user on server-side - allow page to render
// Client-side script will check session and redirect if needed
// This allows client-side logged-in users (with localStorage session) to access onboarding
---

<AppLayout title="Onboarding - DoFIRE">
  <OnboardingContainer client:load />
</AppLayout>

<script>
  // Client-side redirect check for users who already have a profile
  import { supabaseClient } from "../db/supabase.client";

  async function checkProfile() {
    // Wait a bit for session to be available (especially after client-side login)
    // This gives time for setSession() in LoginForm to complete
    await new Promise((resolve) => setTimeout(resolve, 500));
    
    let session = null;
    
    // Try getSession() first
    const { data: { session: getSessionResult } } = await supabaseClient.auth.getSession();
    session = getSessionResult;
    
    // If no session, try sessionStorage fallback (from LoginForm)
    if (!session) {
      console.log("Onboarding: No session from getSession(), checking sessionStorage...");
      const sessionStorageData = sessionStorage.getItem('supabase.auth.session');
      if (sessionStorageData) {
        try {
          const parsedSession = JSON.parse(sessionStorageData);
          console.log("Onboarding: Found session in sessionStorage, restoring...");
          // Try to set session from sessionStorage
          const { error: setError } = await supabaseClient.auth.setSession({
            access_token: parsedSession.access_token,
            refresh_token: parsedSession.refresh_token,
          });
          
          if (setError) {
            console.error("Onboarding: Error setting session from sessionStorage:", setError.message);
          } else {
            console.log("Onboarding: setSession() succeeded, waiting for sync...");
            // Wait for session to sync to localStorage
            await new Promise((resolve) => setTimeout(resolve, 500));
            
            // Try getSession() again
            const { data: { session: restoredSession }, error: getError } = await supabaseClient.auth.getSession();
            if (getError) {
              console.error("Onboarding: Error getting session after set:", getError.message);
            } else if (restoredSession) {
              session = restoredSession;
              // Clear sessionStorage after successful restore
              sessionStorage.removeItem('supabase.auth.session');
              console.log("Onboarding: Session restored from sessionStorage and verified");
            } else {
              console.warn("Onboarding: setSession() succeeded but getSession() still returns null");
              // Use session from sessionStorage directly as fallback
              session = {
                access_token: parsedSession.access_token,
                refresh_token: parsedSession.refresh_token,
                expires_at: parsedSession.expires_at,
                // We need user info, but we can use the token for API calls
              } as any;
              console.log("Onboarding: Using session from sessionStorage directly (fallback)");
            }
          }
        } catch (e) {
          console.error("Onboarding: Error parsing sessionStorage:", e);
        }
      }
    }
    
    if (!session) {
      // No session - wait a bit more and retry (session might still be syncing)
      console.log("Onboarding: No session found, waiting and retrying...");
      await new Promise((resolve) => setTimeout(resolve, 1000));
      const { data: { session: retrySession } } = await supabaseClient.auth.getSession();
      
      if (!retrySession) {
        // Still no session - redirect to login
        console.log("Onboarding: Still no session, redirecting to /login");
        window.location.href = "/login";
        return;
      }
      session = retrySession;
    }

    // Check if user is trying to add investment (step=2) - if so, skip profile check
    const urlParams = new URLSearchParams(window.location.search);
    const stepParam = urlParams.get("step");
    if (stepParam === "2") {
      // User wants to add investment - allow them to stay on onboarding step 2
      // Don't check profile, just let them add investment
      console.log("Onboarding: step=2 detected, allowing to add investment");
      return;
    }

    try {
      const response = await fetch("/api/v1/me/profile", {
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (response.ok) {
        // Profile exists - allow user to edit profile (don't redirect)
        // User can access /onboarding to edit their profile
        console.log("Onboarding: Profile exists, allowing profile editing");
        return;
      } else if (response.status === 404) {
        // No profile - stay on onboarding (this is expected)
        console.log("Onboarding: No profile found (expected), staying on onboarding");
        return;
      } else if (response.status === 401) {
        // Unauthorized - redirect to login
        console.log("Onboarding: Unauthorized, redirecting to /login");
        await supabaseClient.auth.signOut();
        window.location.href = "/login";
      }
    } catch (error) {
      // Network error - allow user to continue (they might be offline)
      console.error("Onboarding: Error checking profile:", error);
    }
  }

  // Check profile on page load
  if (typeof window !== "undefined") {
    checkProfile();
  }
</script>

